<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emotion Record</title>
<style>
  :root { color-scheme: light dark; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:920px;margin:20px auto;padding:0 12px}
  .card{border:1px solid #333;border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 1px 4px rgba(0,0,0,.12);background:#121212}
  button{padding:10px 14px;border-radius:10px;border:1px solid #444;background:#1e1e1e;color:#f1f1f1;cursor:pointer}
  button:hover:not(:disabled){ background:#2a2a2a }
  button:disabled{ background:#2a2a2a; color:#9aa; border-color:#444; opacity:1; cursor:not-allowed }
  code{background:#1a1a1a;padding:2px 6px;border-radius:6px}
  .ok{color:#27c052;font-weight:700}.bad{color:#ff5252;font-weight:700}.muted{color:#b0b0b0}
  input,textarea,select{width:100%;padding:8px;border:1px solid #444;border-radius:10px;background:#1a1a1a;color:#eee}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > * { flex:1 }
  .logbox{white-space:pre-wrap;height:180px;overflow:auto;background:#0f0f0f;color:#e8e8e8;border:1px solid #333;border-radius:8px;padding:8px;font-family:ui-monospace,Consolas,monospace}
  .pill{display:inline-block;border:1px solid #444;border-radius:999px;padding:6px 10px;background:#1a1a1a}
  .goalok{color:#27c052}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal .box{background:#171717;border:1px solid #333;border-radius:14px;padding:18px;max-width:460px;width:92%}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btns button{flex:1}
</style>
</head>
<body>
<h1>Emotion Record</h1>

<div class="card">
  <h2>çŠ¶æ…‹</h2>
  <p>
    BLE: <span id="bleState">æœªæ¥ç¶š</span> ï¼
    Spotify: <span id="spState">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
  </p>
  <div class="row">
    <button id="btnBle">å¿ƒæ‹ã‚»ãƒ³ã‚µãƒ¼æ¥ç¶šï¼ˆCOOSPOï¼‰</button>
    <button id="btnSp">Spotifyãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="btnStart">ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</button>
    <button id="btnStop" disabled>ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†</button>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>æœ¬æ—¥ã®æ¡ä»¶ï¼ˆè§£æç”¨ãƒ©ãƒ™ãƒ«ï¼‰</label>
      <select id="cond">
        <option value="NONE">NONEï¼ˆä»‹å…¥ãªã—ï¼‰</option>
        <option value="SCENT">SCENTï¼ˆé¦™ã‚Šã®ã¿ï¼‰</option>
        <option value="MUSIC">MUSICï¼ˆéŸ³æ¥½ã®ã¿ï¼‰</option>
        <option value="BOTH">BOTHï¼ˆè¤‡åˆï¼‰</option>
      </select>
      <small class="muted">â€» ã“ã“ã¯è§£æç”¨ãƒ©ãƒ™ãƒ«ã€‚å®Ÿéš›ã®ä»‹å…¥ã¯åˆ¤å®šã§åˆ¶å¾¡ã€‚</small>
    </div>
    <div>
      <label>å‚åŠ è€…IDï¼ˆpidï¼‰</label>
      <input id="pid" placeholder="hiro" value="hiro"/>
    </div>
    <div>
      <label>æœ¬æ—¥ã®ç›®æ¨™æ™‚é–“</label>
      <select id="goalMin">
        <option value="90">90åˆ†</option>
        <option value="120" selected>120åˆ†</option>
        <option value="150">150åˆ†</option>
      </select>
      <div id="goalView" class="muted pill" style="margin-top:6px">é€²æ—: 0 / 120åˆ†</div>
    </div>
  </div>
</div>

<div class="card">
  <h2>ãƒ­ã‚°</h2>
  <pre id="log" class="logbox"></pre>
  <div class="row">
    <button id="btnCsv" disabled>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button id="btnClear">ç”»é¢ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
  </div>
</div>

<div class="card">
  <h2>å°±å¯å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
  <div class="row">
    <div><label>ã„ã¾ã®æ°—åˆ†ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="mood" min="0" max="10"/></div>
    <div><label>ãƒªãƒ©ãƒƒã‚¯ã‚¹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="relax" min="0" max="10"/></div>
  </div>
  <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><textarea id="notes" rows="2" placeholder="å¯ã¤ããƒ»å‡ºæ¥äº‹ãªã©"></textarea>
  <button id="btnNote">è¿½åŠ </button>
</div>

<!-- ESM ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="esmModal" class="modal" role="dialog" aria-modal="true" aria-label="ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ">
  <div class="box">
    <h3 style="margin:0 0 8px">ã„ã¾ã®æ„Ÿã˜ã¯ï¼Ÿ</h3>
    <p class="muted" style="margin:0 0 10px">â€» ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§OKï¼ˆç´„3ç§’ï¼‰</p>
    <div class="btns">
      <button data-esm="tense">ç·Šå¼µï¼ˆé«˜ã¶ã‚Š/ç„¦ã‚Šï¼‰</button>
      <button data-esm="calm">é®é™ï¼ˆè½ã¡ç€ãï¼‰</button>
      <button data-esm="depress">è½ã¡è¾¼ã¿ï¼ˆæ°—åˆ†â†“ï¼‰</button>
      <button data-esm="skip">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
  </div>
</div>

<script>
// ====== è¨­å®š ======
const SPOTIFY_CLIENT_ID = "7838a0cf003644ae8b5f3f75b9eb534e";
const REDIRECT_URI       = location.origin + location.pathname;
const SCOPES = [
  "user-read-playback-state","user-modify-playback-state",
  "playlist-read-private","playlist-read-collaborative","streaming"
].join(" ");
const PLAYLIST_TENSION_TO_CALM = "spotify:playlist:6lEP2HI9ecRpSoHQNRTok7";
const PLAYLIST_DEPRESS_TO_LIFT = "spotify:playlist:0TFRed2ZNnofW4uGxjytvT";
const PLAYLIST_CALM_MAINTAIN   = "spotify:playlist:2m9HoHfpO0tk5eky1fopVu";

// ====== Zã—ãã„å€¤ & ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ ======
// æ¨å¥¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆå€‹äººæœ€é©ã¯å¾Œã§å¾®èª¿æ•´å¯ï¼‰
const Z_RMSSD_LOW  = -0.8;   // ã“ã‚Œä»¥ä¸‹â†’ç·Šå¼µå´
const Z_RMSSD_HIGH = +0.8;   // ã“ã‚Œä»¥ä¸Šâ†’é®é™å´
const Z_HR_HIGH    = +0.6;   // HRé«˜ã¶ã‚Šï¼ˆç·Šå¼µè£œå¼·ï¼‰
const Z_HR_LOW     = -1.0;   // HRä½ä¸‹ï¼ˆè½ã¡è¾¼ã¿è£œå¼·ï¼‰
const HYSTERESIS_N = 3;      // 3åˆ†é€£ç¶šã§çŠ¶æ…‹ç¢ºå®š

// ====== è¦ç´  ======
const logEl = document.getElementById("log");
const bleStateEl = document.getElementById("bleState");
const spStateEl  = document.getElementById("spState");
const btnCsv = document.getElementById("btnCsv");
const btnClear = document.getElementById("btnClear");
const condSel = document.getElementById("cond");
const goalSel = document.getElementById("goalMin");
const goalView = document.getElementById("goalView");
const esmModal = document.getElementById("esmModal");

// ====== çŠ¶æ…‹å¤‰æ•° ======
let hr = null, rrList = [];           // RR(ç§’)
let timer = null;
let esmTimer = null;
let sessionId = Math.random().toString(36).slice(2,10);
let spotifyAccessToken = null;
let csvRows = [[]];

let validMin = 0;
let playMin  = 0;
let anyBLE   = false;
let bleDropped = false;
let lastHadBLE = false;

// ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåˆ‡æ›¿åˆ¶å¾¡
let currentEmotionKey = null; // "tension"/"calm"/"depress"
let waitingSwitch = false;

// ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ç”¨
let rawStreakEmotion = null;  // ç›´è¿‘ã®â€œç”Ÿåˆ¤å®šâ€ã®æ„Ÿæƒ…
let rawStreakCount   = 0;     // ãã®é€£ç¶šåˆ†
let stableEmotion    = "unknown"; // CSVã¸ã¯ã“ã®â€œç¢ºå®šçŠ¶æ…‹â€ã‚’æ›¸ãå‡ºã™

function log(s){ logEl.textContent += s + "\n"; logEl.scrollTop = logEl.scrollHeight; }
function clearLog(){ logEl.textContent = ""; }
function isoNow(){ return new Date().toISOString().replace("T"," ").slice(0,19); }

// ---- HRV: RMSSDï¼ˆRRã¯ç§’å˜ä½ï¼‰
function calcRMSSD(rrs){
  if(rrs.length < 3) return null;
  let sum = 0, n = 0;
  for(let i=1;i<rrs.length;i++){
    const diff = (rrs[i]-rrs[i-1]);
    sum += diff*diff; n++;
  }
  return Math.sqrt(sum/n); // ç§’
}

// ============ Web Bluetooth ============
async function connectBLE(){
  try{
    log("BLE: ãƒ‡ãƒã‚¤ã‚¹é¸æŠâ€¦");
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{services:["heart_rate"]}], optionalServices:["heart_rate"]
    });
    const server = await dev.gatt.connect();
    const service = await server.getPrimaryService("heart_rate");
    const ch = await service.getCharacteristic("heart_rate_measurement");
    await ch.startNotifications();
    ch.addEventListener("characteristicvaluechanged", (e)=>{
      const v = e.target.value;
      const flags = v.getUint8(0);
      const hrValue = (flags & 0x01) ? v.getUint16(1,true) : v.getUint8(1);
      hr = hrValue;
      anyBLE = true;
      lastHadBLE = true;
      let idx = (flags & 0x01) ? 3 : 2;
      const rrLocal = [];
      while(idx+1 < v.byteLength){
        const rr = v.getUint16(idx,true)/1024.0; // ç§’
        rrLocal.push(rr); idx += 2;
      }
      if(rrLocal.length){
        rrList.push(...rrLocal);
        if(rrList.length>60) rrList = rrList.slice(-60);
      }
      bleStateEl.textContent = `æ¥ç¶šä¸­ï¼ˆHR=${hr})`;
    });

    dev.addEventListener("gattserverdisconnected", ()=>{
      bleStateEl.textContent = "åˆ‡æ–­";
      if(lastHadBLE) bleDropped = true;
      lastHadBLE = false;
    });

    bleStateEl.textContent = "æ¥ç¶šå®Œäº†";
    log("BLE: æ¥ç¶šã—ã¾ã—ãŸ");
  }catch(err){
    log("BLE error: "+err.message);
    bleStateEl.textContent = "æœªæ¥ç¶š";
  }
}

// ============ Spotify (PKCE) ============
function base64url(bytes){
  return btoa(String.fromCharCode(...new Uint8Array(bytes)))
    .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
async function pkce(){
  const ver = base64url(crypto.getRandomValues(new Uint8Array(32)));
  const enc = new TextEncoder().encode(ver);
  const digest = await crypto.subtle.digest("SHA-256", enc);
  const chal = base64url(digest);
  sessionStorage.setItem("pkce_verifier", ver);
  return chal;
}
async function loginSpotify(){
  const params = new URLSearchParams(location.search);
  const code = params.get("code");
  if(!code){
    const challenge = await pkce();
    const url = "https://accounts.spotify.com/authorize?" + new URLSearchParams({
      client_id: SPOTIFY_CLIENT_ID,
      response_type: "code",
      redirect_uri: REDIRECT_URI,
      scope: SCOPES,
      code_challenge_method: "S256",
      code_challenge: challenge
    });
    location.href = url;
    return;
  }
  const ver = sessionStorage.getItem("pkce_verifier");
  const body = new URLSearchParams({
    grant_type:"authorization_code", code,
    redirect_uri:REDIRECT_URI, client_id:SPOTIFY_CLIENT_ID, code_verifier:ver
  });
  const r = await fetch("https://accounts.spotify.com/api/token", {
    method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded" }, body
  });
  const tok = await r.json();
  if(tok.access_token){
    spotifyAccessToken = tok.access_token;
    spStateEl.textContent = "ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿";
    log("Spotify: ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†");
    history.replaceState({}, "", REDIRECT_URI);
  }else{
    log("Spotify ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—: "+JSON.stringify(tok));
  }
}
async function spRequest(method, url, body){
  if(!spotifyAccessToken) throw new Error("no token");
  return fetch(url, {
    method, headers:{ "Authorization":"Bearer "+spotifyAccessToken, "Content-Type":"application/json" },
    body: body? JSON.stringify(body): undefined
  });
}
async function ensureShuffleOn(){
  try{ await spRequest("PUT","https://api.spotify.com/v1/me/player/shuffle?state=true"); }
  catch(e){ log("shuffle err: "+e.message); }
}
async function getCurrentPlaying(){
  try{
    const r = await spRequest("GET","https://api.spotify.com/v1/me/player/currently-playing");
    if(r.status===204) return null;
    return await r.json();
  }catch(_){ return null; }
}
function extractTrackInfo(j){
  try{
    if(!j || !j.is_playing || !j.item) return {track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false};
    const item = j.item;
    const artists = (item.artists||[]).map(a=>a.name).join(", ");
    const ctx = (j.context && j.context.uri) ? j.context.uri : "";
    return {
      track_id:item.id||"", track_name:item.name||"", artists, context_uri: ctx,
      duration_ms: item.duration_ms||0, progress_ms: j.progress_ms||0, is_playing: !!j.is_playing
    };
  }catch(_){ return {track_id:"",track_name:"",artists:"",context_uri:"",duration_ms:0,progress_ms:0,is_playing:false}; }
}
async function playPlaylist(uri){
  await ensureShuffleOn();
  const r = await spRequest("PUT","https://api.spotify.com/v1/me/player/play",{ context_uri: uri, position_ms:0 });
  if(!r.ok) log("play err: "+(await r.text()).slice(0,200));
}

// ===== ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåˆ‡æ›¿ï¼šæ›²æœ«ã¾ã§å¾…ã¤ & åŒã˜æ„Ÿæƒ…ã¯åˆ‡æ›¿ãˆãªã„
async function scheduleSwitchIfNeeded(targetKey){
  if(targetKey===currentEmotionKey) return;
  if(waitingSwitch) return;
  waitingSwitch = true;

  const uri = (
    targetKey==="tension" ? PLAYLIST_TENSION_TO_CALM :
    targetKey==="depress" ? PLAYLIST_DEPRESS_TO_LIFT :
    PLAYLIST_CALM_MAINTAIN
  );

  const deadline = Date.now()+5*60*1000;
  while(Date.now() < deadline){
    let j = null;
    try{ j = await getCurrentPlaying(); }catch{}
    const info = extractTrackInfo(j);
    if(!info.is_playing || !info.duration_ms){ break; }
    const remain = Math.max(0, info.duration_ms - (info.progress_ms||0));
    if(remain <= 3500) break;
    await new Promise(r=>setTimeout(r, 1500));
  }
  await playPlaylist(uri);
  currentEmotionKey = targetKey;
  waitingSwitch = false;
  log(`ğŸµ Playlist â†’ ${targetKey}`);
}

// ============ Zã‚¹ã‚³ã‚¢åˆ¤å®šï¼ˆç”Ÿåˆ¤å®šï¼‰ ============
// â€» ã“ã“ã¯â€œç”Ÿâ€ã®1åˆ†åˆ¤å®šã€‚ç¢ºå®šã¯ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹é©ç”¨å¾Œã€‚
function decideRawByZ(z_hr, z_rmssd){
  if(z_hr==="" || z_rmssd==="") return "unknown";
  // ç·Šå¼µï¼šRMSSDä½ä¸‹ï¼†HRä¸ŠæŒ¯ã‚Œ
  if(z_rmssd <= Z_RMSSD_LOW && z_hr >= Z_HR_HIGH) return "tension";
  // é®é™ï¼šRMSSDä¸Šæ˜‡ï¼†HRã¯æ¥µç«¯ã«é«˜ããªã„
  if(z_rmssd >= Z_RMSSD_HIGH && z_hr <= +0.3) return "calm";
  // è½ã¡è¾¼ã¿ï¼šHRä½ä¸‹ã§RMSSDã¯ä¸­åº¸
  if(z_hr <= Z_HR_LOW && z_rmssd > -0.3 && z_rmssd < +0.3) return "depress";
  return "unknown";
}

// ============ ESMï¼ˆ30åˆ†ãŠãÂ±ã‚†ã‚‰ãï¼‰ ============
function randomMinutes(min, max){ return Math.floor(min + Math.random()*(max-min+1)); }
function scheduleNextESM(){
  clearTimeout(esmTimer);
  const m = randomMinutes(28,34);
  esmTimer = setTimeout(()=>{ showESM(); }, m*60*1000);
}
function showESM(){ esmModal.style.display = "flex"; }
function hideESM(){ esmModal.style.display = "none"; }
esmModal.addEventListener("click",(e)=>{ if(e.target===esmModal) hideESM(); });
esmModal.querySelectorAll("button[data-esm]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const val = btn.getAttribute("data-esm");
    csvRows.push([
      Date.now(), isoNow(),
      (document.getElementById("pid").value||"pid"),
      new Date().toLocaleDateString("ja-JP"),
      sessionId, "block1", condSel.value,
      "", "", "", "", "", "", "",
      "", "", "", // roll std
      "", "", "", "", // track
      "", "", "", "", // baselines
      "", "", "",     // playing/exercise/valid_for_rank
      "", "", "",     // mood/relax/note
      "esm", val,
      "", ""
    ]);
    log(`ğŸ—³ï¸ ESM: ${val}`);
    hideESM();
    scheduleNextESM();
  });
});

// ============ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡ ============
let prevHR=null, prevRMSSD=null;
// å€‹äººãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆEWMAã§å¾®æ›´æ–°ï¼‰
let hr_base = 70, sd_hr = 8;
let rmssd_base = 0.04, sd_rmssd = 0.015;
const EWMA = 0.05;

function makeHeader(){
  csvRows = [[
    "timestamp","datetime","pid","day","session_id","block","condition",
    "hr","rmssd","rmssd_ms","z_hr","z_rmssd","d_hr","d_rmssd",
    "roll_std_h","roll_std_rr","emotion",
    "track_id","track_name","artists","context_uri",
    "hr_base","rmssd_base","sd_hr","sd_rmssd",
    "is_playing","exercise","valid_for_rank",
    "mood","relax","note",
    "event","esm",
    "session_minutes_valid","reason_invalid"
  ]];
}

async function startSession(){
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnStop").disabled = false;
  btnCsv.disabled = true;
  makeHeader();
  sessionId = Math.random().toString(36).slice(2,10);
  validMin = 0; playMin = 0; anyBLE = false; bleDropped = false; lastHadBLE = false;
  currentEmotionKey = null; waitingSwitch = false;
  rawStreakEmotion = null; rawStreakCount = 0; stableEmotion = "unknown";
  updateGoalView();

  log("ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: "+sessionId);
  scheduleNextESM();

  timer = setInterval(async ()=>{
    const dayStr = new Date().toLocaleDateString("ja-JP");
    const pid = (document.getElementById("pid").value||"").trim() || "pid";
    const condition = condSel.value;
    const goal = parseInt(goalSel.value||"120",10);

    const rmssd = calcRMSSD(rrList.slice(-10));
    const rmssd_ms = rmssd!=null ? Math.round(rmssd*1000) : "";
    const z_hr = (hr!=null) ? (hr-hr_base)/sd_hr : "";
    const z_rmssd = (rmssd!=null) ? (rmssd-rmssd_base)/sd_rmssd : "";
    const d_hr = (prevHR!=null && hr!=null) ? (hr-prevHR) : "";
    const d_rmssd = (prevRMSSD!=null && rmssd!=null) ? (rmssd-prevRMSSD) : "";

    // é‹å‹•ã–ã£ãã‚Šé™¤å¤–
    const exercise = (hr!=null && hr_base!=null && hr >= hr_base+25) ? 1 : 0;

    // SpotifyçŠ¶æ…‹
    let playing = false, track = {track_id:"",track_name:"",artists:"",context_uri:"",is_playing:false};
    try{
      const j = await getCurrentPlaying();
      const info = extractTrackInfo(j);
      playing = !!info.is_playing;
      track = info;
    }catch{}

    // â€œç”Ÿåˆ¤å®šâ€ â†’ ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ã§â€œç¢ºå®šçŠ¶æ…‹â€ã¸
    let raw = decideRawByZ(z_hr, z_rmssd);
    if(exercise) raw = "unknown"; // é‹å‹•ã¯é™¤å¤–
    if(rawStreakEmotion === raw){
      rawStreakCount += 1;
    }else{
      rawStreakEmotion = raw;
      rawStreakCount = 1;
    }
    if(raw !== "unknown" && rawStreakCount >= HYSTERESIS_N && raw !== stableEmotion){
      stableEmotion = raw; // çŠ¶æ…‹ç¢ºå®š
      log(`ğŸ§  Emotionç¢ºå®š: ${stableEmotion}ï¼ˆZhr=${z_hr=== ""?"":z_hr.toFixed(2)}, Zrmssd=${z_rmssd===""?"":z_rmssd.toFixed(2)}ï¼‰`);
    }

    // ä»‹å…¥ãƒ­ã‚¸ãƒƒã‚¯ï¼šMUSIC/BOTH ã‹ã¤ é‹å‹•é™¤å¤–æ™‚ã®ã¿
    if((condition==="MUSIC" || condition==="BOTH") && !exercise){
      const targetKey = (
        stableEmotion==="tension" ? "tension" :
        stableEmotion==="depress" ? "depress" :
        stableEmotion==="calm"    ? "calm"    : null
      );
      if(targetKey){ scheduleSwitchIfNeeded(targetKey); }
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ï¼ˆè§£æç”¨ï¼‰ï¼šNONEÃ—å†ç”Ÿä¸­Ã—é‹å‹•ãªã—
    const valid_for_rank = (condition==="NONE" && playing && !exercise) ? 1 : 0;

    // æœ‰åŠ¹åˆ†ã‚«ã‚¦ãƒ³ãƒˆ
    const gotHR = (hr!=null);
    if(gotHR){
      if(condition==="MUSIC" || condition==="BOTH"){
        if(playing && !exercise) { validMin++; playMin++; }
      }else{
        if(!exercise) validMin++;
      }
    }
    updateGoalView(goal);

    // CSVè¡Œï¼ˆemotionã¯â€œç¢ºå®šçŠ¶æ…‹â€ã‚’æ›¸ãå‡ºã™ï¼‰
    csvRows.push([
      Date.now(), isoNow(), pid, dayStr, sessionId, "block1", condition,
      hr??"", rmssd??"", rmssd_ms, z_hr===""?"":z_hr, z_rmssd===""?"":z_rmssd, d_hr, d_rmssd,
      "", "", stableEmotion,
      track.track_id, track.track_name, track.artists, track.context_uri,
      hr_base, rmssd_base, sd_hr, sd_rmssd,
      playing?1:0, exercise, valid_for_rank,
      "", "", "",
      "", "",
      "", ""
    ]);

    // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç·©æ›´æ–°ï¼ˆä¸­ç«‹å¸¯ã®ã¿ï¼‰
    if(rmssd!=null && hr!=null && z_hr!=="" && z_rmssd!=="" && Math.abs(z_hr)<0.5 && z_rmssd>-0.3){
      hr_base    = (1-EWMA)*hr_base    + EWMA*hr;
      rmssd_base = (1-EWMA)*rmssd_base + EWMA*rmssd;
      sd_hr      = (1-EWMA)*sd_hr      + EWMA*Math.abs(hr-hr_base);
      sd_rmssd   = (1-EWMA)*sd_rmssd   + EWMA*Math.abs(rmssd-rmssd_base);
    }

    prevHR = hr; prevRMSSD = rmssd;
  }, 60*1000);
}

function stopSession(){
  clearInterval(timer); timer=null;
  clearTimeout(esmTimer); esmTimer=null;
  document.getElementById("btnStart").disabled = false;
  document.getElementById("btnStop").disabled = true;
  btnCsv.disabled = false;

  const condition = condSel.value;
  let reasons = [];
  if(validMin < 60) reasons.push("<60min");
  if((condition==="MUSIC" || condition==="BOTH") && playMin < 30) reasons.push("playing<30");
  if(bleDropped) reasons.push("ble_drop");
  const reason_invalid = reasons.join("+") || "";

  if(csvRows.length>1){
    const last = csvRows[csvRows.length-1];
    last[last.length-2] = validMin.toString();
    last[last.length-1] = reason_invalid;
  }else{
    csvRows.push([Date.now(), isoNow(), (document.getElementById("pid").value||"pid"), new Date().toLocaleDateString("ja-JP"), sessionId, "block1", condition,
      "","","","","","","","","","",
      "","","","",
      hr_base, rmssd_base, sd_hr, sd_rmssd,
      0,0,0,
      "","","",
      "end","",
      validMin.toString(), reason_invalid
    ]);
  }

  log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼ˆæœ‰åŠ¹åˆ†=${validMin}åˆ†, å†ç”Ÿåˆ†=${playMin}åˆ†, ç†ç”±=${reason_invalid||"ãªã—"}ï¼‰`);
}

function updateGoalView(goal){
  const g = goal ? goal : parseInt(goalSel.value||"120",10);
  const ok = (validMin >= g);
  goalView.textContent = `é€²æ—: ${validMin} / ${g}åˆ†` + (ok ? " âœ…" : "");
  goalView.classList.toggle("goalok", ok);
}

// ã‚¢ãƒ³ã‚±ï¼šç›´è¿‘è¡Œã¸è¿½è¨˜
document.getElementById("btnNote").onclick = ()=>{
  const mood = document.getElementById("mood").value||"";
  const relax = document.getElementById("relax").value||"";
  const notes = document.getElementById("notes").value||"";
  if(csvRows.length>1){
    const last = csvRows[csvRows.length-1];
    const idxMood  = csvRows[0].indexOf("mood");
    const idxRelax = csvRows[0].indexOf("relax");
    const idxNote  = csvRows[0].indexOf("note");
    last[idxMood]  = mood;
    last[idxRelax] = relax;
    last[idxNote]  = notes;
  }
  log("ã‚¢ãƒ³ã‚±è¿½åŠ ");
};

// CSVä¿å­˜
btnCsv.onclick = ()=>{
  const blob = new Blob([csvRows.map(r=>r.join(",")).join("\n")], {type:"text/csv"});
  const dayStr = new Date().toISOString().slice(0,10);
  const a = Object.assign(document.createElement("a"), {
    href: URL.createObjectURL(blob),
    download: `emotion_log_${dayStr}_${sessionId}.csv`
  });
  a.click(); URL.revokeObjectURL(a.href);
};

btnClear.onclick = clearLog;

// UIã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById("btnBle").onclick = connectBLE;
document.getElementById("btnSp").onclick = loginSpotify;
document.getElementById("btnStart").onclick = startSession;
document.getElementById("btnStop").onclick = stopSession;

// code=? ã§æˆ»ã£ã¦ããŸã‚‰è‡ªå‹•äº¤æ›
if(new URLSearchParams(location.search).get("code")) loginSpotify();
</script>
</body>
</html>
